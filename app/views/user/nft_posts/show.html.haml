%section.nft_section
  .container-fluid.d-flex.p-0.nft_sectionInner
    .LeftSlider
      .NftSlider-2.slider-Outer
        %div
          .NFTSL_Box.d-flex.align-item-center
            .Nft_img.d-flex.align-items-center
              %img{src: "#{@nft_post.attachment_url}"}
    .RightContent
      %div
        .modHead.py-4.px-4
          .modLabel
            = @nft_post.nft_id
            %br/
            = @nft_post.title
          .d-flex.mt-3.align-items-center.justify-content-between
            .md_bottom
              %span.me-3
                %img{alt: "", src: "/user/img/default/moderate-img.png"}/
              = "by #{@nft_post.user.name || @nft_post.user.email} "
            .md_bottom
              = @nft_post.category
        .pt-5.py-4.px-4.mb-padding.graphOuter
          .graph_sec
            .graph_prg
            .graph_line
        .pt-5.py-4.px-4.mb-padding
          .about_Sec
            %h1.abt-label.color-3 About
            %p.abt-para
              = @nft_post.description
        .priceStatusOuter.mb-padding.pt-3.py-3.px-4.by-5.d-flex.align-items-end.justify-content-between
          .priceStatus.d-flex
            .pricSec
              %p.m-0.cp-label Current Price
              %p.m-0.pr-lable.color-2
                = @nft_post.listing_price
            .ms-3.me-4
              %img.pr-img{alt: "", src: "/user/img/default/prImg.png"}/
            .pricSec
              %p.m-0.cp-label Start Price
              %p.m-0.pr-lable.color-2
                = @nft_post.start_price
            .ms-3.me-4
              %img.pr-img{alt: "", src: "/user/img/default/prImg.png"}/
            .pricSec
              %p.m-0.cp-label Target Price
              %p.m-0.pr-lable.color-2
                = @nft_post.target_price

        .priceStatusOuter.mb-padding.pt-3.py-3.px-4.by-5.d-flex.align-items-end.justify-content-between
          .priceStatus.d-flex
            .pricSec
              %p.m-0.cp-label Offer End Time
              %p.m-0.pr-lable.timerStatus
                = @nft_post.listing_price

        .pt-3.py-3.px-4.mb-padding
          .btnOuterSection.d-flex.justify-content-between.align-items-center
            .btn-outer-1.d-flex.flex-lg-row.flex-column.justify-content-start.align-items-center
              %a.btn.px-5.py-2.mod-btn.btn-primary.bg-color-2.br-style-1.mb-3.mb-lg-0.me-lg-3.fw-6{href: "#link-6"} Buy now

              = link_to new_user_offer_path, { remote: true, 'data-toggle' =>  "modal", 'data-target' => '#modal-window', class: 'btn px-5 py-2 mod-btn btn-outline-primary bg-white br-style-2 fw-6' } do
                %span.color-2 Make Offer
            .btnsOuter.d-flex
              .scImg.d-flex.justify-content-center.align-items-center.me-4
                %img{alt: "", src: "/user/img/default/share.png"}/
                %p.scNum.color-2 974
              .scImg.d-flex.justify-content-center.align-items-center
                %img{alt: "", src: "/user/img/default/heart.png"}/
                %p.scNum.color-2 12354
        .pt-5.py-3.px-4.simiOuter.mb-padding
          .color-3.cl-label.mb-3 Similar NFTs
          .mb-3.d-flex.flex-wrap.deskBox
            .modBox
              .SL_Box
                .img-box
                  %img{src: "/user/img/default/img-1.png"}/
                .text-box.w-100.d-flex.justify-content-between
                  .text-box-left.d-flex.flex-column.justify-content-center.align-items-center.align-items-lg-start
                    %span.name-1 Talinhos
                    %strong.name-2 Moderator
                    %strong.name-3 #001
                  .text-box-right.d-flex.flex-column.justify-content-end.align-items-end
                    %span.name-4 654
                    %span.name-5.d-flex.align-items-center
                      16,320
                      %img.like-icon{src: "/user/img/default/like.png"}/
            .modBox
              .SL_Box
                .img-box
                  %img{src: "/user/img/default/img-1.png"}/
                .text-box.w-100.d-flex.justify-content-between
                  .text-box-left.d-flex.flex-column.justify-content-center.align-items-center.align-items-lg-start
                    %span.name-1 Talinhos
                    %strong.name-2 Moderator
                    %strong.name-3 #001
                  .text-box-right.d-flex.flex-column.justify-content-end.align-items-end
                    %span.name-4 654
                    %span.name-5.d-flex.align-items-center
                      16,320
                      %img.like-icon{src: "/user/img/default/like.png"}/
            .modBox
              .SL_Box
                .img-box
                  %img{src: "/user/img/default/img-1.png"}/
                .text-box.w-100.d-flex.justify-content-between
                  .text-box-left.d-flex.flex-column.justify-content-center.align-items-center.align-items-lg-start
                    %span.name-1 Talinhos
                    %strong.name-2 Moderator
                    %strong.name-3 #001
                  .text-box-right.d-flex.flex-column.justify-content-end.align-items-end
                    %span.name-4 654
                    %span.name-5.d-flex.align-items-center
                      16,320
                      %img.like-icon{src: "/user/img/default/like.png"}/

        .pt-3.pt-3.px-4.simiOuter.mb-padding
          .color-2.cl-label Other Collections by Talentsverse
          .TC-outer.flex-wrap.d-flex.flex-row.justify-content-center.align-items-center.mt-4.mx-auto.TC-outerDesk-view
            .TC-item.d-flex.flex-column.align-items-between.me-md-4.mb-3.mb-lg-4
              .TC-img
                %img{src: "/user/img/default/trading.png"}/
              .TC-details-outer.h-100.d-flex.flex-column.justify-content-between
                .TC-details.d-flex.flex-column
                  .TC-1.d-flex.flex-column.justify-content-center.align-items-center.pt-3
                    %p.mb-0.fs-18
                      %strong Talinhos
                    %p.mb-0
                      %small by
                    %p.mb-0.fs-18
                      %span Talentsverse
                .TC-details.d-flex.flex-row.justify-content-center.align-items-center.pt-3.pb-3.pb-xl-4
                  %small.flex-1.text-center 16,547 Views
                  %span.flex-1.text-center.color-2.fs-18 ...
                  %small.flex-1.text-center 1,414 Likes
            .TC-item.d-flex.flex-column.align-items-between.me-md-4.mb-3.mb-lg-4
              .TC-img
                %img{src: "/user/img/default/trading.png"}/
              .TC-details-outer.h-100.d-flex.flex-column.justify-content-between
                .TC-details.d-flex.flex-column
                  .TC-1.d-flex.flex-column.justify-content-center.align-items-center.pt-3
                    %p.mb-0.fs-18
                      %strong Talinhos
                    %p.mb-0.fs-18.mt-1
                      %span Diverse
                .TC-details.d-flex.flex-row.justify-content-center.align-items-center.pt-3.pb-3.pb-xl-4
                  %small.flex-1.text-center 16,547 Views
                  %span.flex-1.text-center.color-2.fs-18 ...
                  %small.flex-1.text-center 1,414 Likes

#modal-window.modal.hide.fade{"aria-hidden" => "true", "aria-labelledby" => "myModalLabel", role: "dialog"}
  .modal-dialog{role: "document"}
    .modal-content
      .modal-header
        %button.close{"data-dismiss" => "modal", type: "button"} x
        %h4#myModalLabel.modal-title Modal title
      .modal-body
        *Modal content comes here*
      .modal-footer
        %button.btn.btn-primary Save

:javascript

  let marketplaceAbi = undefined;
  let paymentTokenAbi = undefined;

  const setMarketplaceAbi = async () => {
    try {
      var data = await fetch('/user/json/marketPlaceAbi.json');
      marketplaceAbi = await data.json();

      console.log('marketplaceAbi => ', marketplaceAbi);

      return marketplaceAbi
    } catch (error) {
      console.log(error);
    }
  };

  const setPaymentTokenAbi = async () => {
    try {
      var data = await fetch('/user/json/paymentToken.json');
      paymentTokenAbi = await data.json();

      console.log('paymentTokenAbi => ', paymentTokenAbi);

      return paymentTokenAbi
    } catch (error) {
      console.log(error);
    }
  };

  async function getOfferData(offerId) {
    return marketPlaceContract.methods.offers(offerId).call();
  }

  async function getAllowance(baseContract, toApproveContract) {
    return baseContract.methods.allowance(currentAccount, toApproveContract).call();
  }

  async function approve(baseContract, toApproveContract) {
    let maxAmount = Web3.utils.toBN(2).pow(Web3.utils.toBN(256)).sub(Web3.utils.toBN(1)).toString();
    let allowance = await getAllowance(baseContract, toApproveContract);

    if (allowance !== maxAmount) {
      return baseContract.methods.approve(toApproveContract, maxAmount).send({from: currentAccount});
    } else {
      return Promise.resolve();
    }
  }

  async function makeBid(offerId, amount) {
    let weiAmount = await toWei(amount);

    const paymentTokenContract = new provider.Contract(paymentTokenAbi, paymentTokenAddress);
    const marketPlaceContract = new provider.Contract(marketplaceAbi, marketPlaceAddress);

    return approve(paymentTokenContract, marketPlaceAddress).then(() => {
      return marketPlaceContract.methods.makeBid(offerId, weiAmount, "0x").send({from: currentAccount});
    });
  }

  setMarketplaceAbi();
  setPaymentTokenAbi();

  // Remove below functions

  async function getOfferCount() {
    const marketPlaceContract = new provider.Contract(marketplaceAbi, marketPlaceAddress);

    return marketPlaceContract.methods.offerCount().call();
  }

  async function getAllOfferData() {
    let offerCount = await getOfferCount();

    let allOffers = [];
    let currentOffer = undefined;
    for (let i = 1; i <= parseInt(offerCount); i++) {
      currentOffer = await getOfferData(i);
      // TODO: 0-11 deleten

      allOffers.push(currentOffer);
    }

    return allOffers;
  }
